"""Pydantic schemas for the Vulnerability Registry (Module 13)."""
from __future__ import annotations

from datetime import date, datetime

from pydantic import BaseModel, Field


class VulnerabilityOut(BaseModel):
    id: int
    ref_id: str | None = None
    title: str
    description: str | None = None
    source_id: int | None = None
    source_name: str | None = None
    org_unit_id: int
    org_unit_name: str | None = None
    asset_id: int | None = None
    asset_name: str | None = None
    category_id: int | None = None
    category_name: str | None = None
    severity_id: int | None = None
    severity_name: str | None = None
    cvss_score: float | None = None
    cvss_vector: str | None = None
    cve_id: str | None = None
    status_id: int | None = None
    status_name: str | None = None
    remediation_priority_id: int | None = None
    remediation_priority_name: str | None = None
    owner: str
    detected_at: date
    closed_at: date | None = None
    sla_deadline: date | None = None
    remediation_notes: str | None = None
    risk_id: int | None = None
    created_by: str | None = None
    is_active: bool = True
    created_at: datetime
    updated_at: datetime
    model_config = {"from_attributes": True}


class VulnerabilityCreate(BaseModel):
    title: str = Field(..., min_length=1, max_length=255)
    description: str | None = None
    source_id: int | None = None
    org_unit_id: int
    asset_id: int | None = None
    category_id: int | None = None
    severity_id: int | None = None
    cvss_score: float | None = Field(None, ge=0.0, le=10.0)
    cvss_vector: str | None = Field(None, max_length=255)
    cve_id: str | None = Field(None, max_length=20)
    status_id: int | None = None
    remediation_priority_id: int | None = None
    owner: str = Field(..., min_length=1, max_length=100)
    detected_at: date
    sla_deadline: date | None = None
    remediation_notes: str | None = None
    risk_id: int | None = None
    created_by: str | None = Field(None, max_length=100)


class VulnerabilityUpdate(BaseModel):
    title: str | None = Field(None, min_length=1, max_length=255)
    description: str | None = None
    source_id: int | None = None
    org_unit_id: int | None = None
    asset_id: int | None = None
    category_id: int | None = None
    severity_id: int | None = None
    cvss_score: float | None = Field(None, ge=0.0, le=10.0)
    cvss_vector: str | None = Field(None, max_length=255)
    cve_id: str | None = Field(None, max_length=20)
    status_id: int | None = None
    remediation_priority_id: int | None = None
    owner: str | None = Field(None, max_length=100)
    sla_deadline: date | None = None
    remediation_notes: str | None = None
    risk_id: int | None = None
    is_active: bool | None = None


class VulnerabilityStatusChange(BaseModel):
    status_id: int
    remediation_notes: str | None = None


class VulnerabilityBrief(BaseModel):
    id: int
    ref_id: str | None = None
    title: str
    severity_name: str | None = None
    status_name: str | None = None
    cvss_score: float | None = None
    detected_at: date
    sla_deadline: date | None = None
    owner: str
    model_config = {"from_attributes": True}


class VulnerabilityMetrics(BaseModel):
    total_open: int = 0
    by_severity: dict[str, int] = {}
    sla_compliance_pct: float | None = None
    avg_remediation_days: float | None = None
